<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kids Learning Lab™ - By a Kid, For Kids</title>
  <link rel="icon" type="image/png" href="wp-content/uploads/2025/02/podcast-logo-app-rounded.png">
  <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <style>
    /* Reset */
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      color: white;
      font-family: 'Albert Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      margin: 0;
    }
    main { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    h1, h2 { text-align: center; margin-bottom: 1.5rem; }
    .episodes-list { display: flex; flex-direction: column; gap: 1.5rem; max-width: 900px; margin: 0 auto; }
    .episode { display: flex; background: white; border-radius: 8px; overflow: hidden; cursor: default; box-shadow: 0 4px 12px rgb(0 0 0 / 0.1); color: #000; }
    .episode-artwork { flex: 0 0 150px; height: 150px; background-size: cover; background-position: center; border-right: 1px solid #ddd; }
    .episode-content { flex: 1; padding: 12px 16px; display: flex; flex-direction: column; justify-content: space-between; }
    .cta-button { display: inline-block; padding: 10px 16px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; margin-bottom: 1rem; text-align: center; }
    .spotify-note { text-align: center; font-family: Arial, sans-serif; font-size: 14px; color: #555; padding: 10px; background-color: #44ffb0; border-radius: 6px; }
    .spotify-note a { text-decoration: none; font-weight: bold; color: #1DB954; }
    footer { margin-top: 2rem; padding: 1rem; background: rgba(0,0,0,0.2); font-size: 0.85rem; }
    .footer-content img { max-width: 100px; display:block; margin-bottom: 0.5rem; }
    .footer-section ul { list-style: none; padding: 0; margin: 0; }
    .footer-section ul li a { color: white; text-decoration: none; }
    #load-more { padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>
<header>
  <nav style="max-width:900px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:1rem;">
    <div class="logo"><img src="https://kidslearninglab.com/wp-content/uploads/2025/02/podcast-logo-app-rounded.png" width="40"> Kids Learning Lab™</div>
  </nav>
</header>

<main>
  <section id="episodes-list" class="episodes-list">
    <img src="https://kidslearninglab.com/wp-content/uploads/2025/02/podcast-logo-app-rounded.png" width="100" style="margin:0 auto;">
    <h1>Latest Episodes</h1>
    <a class="cta-button" href="availability.html">Where to Listen</a>
    <div class="spotify-note">
      <strong>NOTE:</strong> We are also available on other platforms
      <a href="availability.html" target="_blank">here</a>, like Apple Podcasts and Spotify.
    </div>
    <div id="episodes-container"></div>
    <button id="load-more">Load Episodes</button>
  </section>
</main>

<footer>
  <div style="text-align:center;">
    <img src="https://kidslearninglab.com/wp-content/uploads/2025/02/podcast-logo-app-rounded.png">
    <p>&copy; 2025 Kids Learning Lab Media. Created with ❤ by Eshaan.</p>
  </div>
</footer>

<script>
  const RSS_URL = 'https://anchor.fm/s/d1b8e6fc/podcast/rss';
  let allEpisodes = [], currentIndex = 0;
  const episodesContainer = document.getElementById('episodes-container');
  const loadMoreBtn = document.getElementById('load-more');

  let spotifyEpisodesMap = {};
  async function loadSpotifyEpisodesMap() {
    const res = await fetch('https://food-gen.onrender.com/api/spotify-episodes');
    const data = await res.json();
    data.forEach(ep => {
      spotifyEpisodesMap[ep.title.toLowerCase().trim()] = ep.spotifyId;
    });
  }

  const episodesPerPage = 5;

  function createEpisodeElement(item) {
    const title = item.querySelector('title')?.textContent || '';
    const spotifyId = spotifyEpisodesMap[title.toLowerCase().trim()];
    if (!spotifyId) return document.createElement('div');

    const embedDiv = document.createElement('div');
    embedDiv.style.marginBottom = '2rem';

    // id = lowercase, spaces -> dashes, remove special chars
    embedDiv.id = title.toLowerCase().replace(/\s+/g,'-').replace(/[^\w-]/g,'');

    const iframe = document.createElement('iframe');
    iframe.style.borderRadius = '12px';
    iframe.src = `https://open.spotify.com/embed/episode/${spotifyId}?utm_source=generator`;
    iframe.width = '100%';
    iframe.height = '152';
    iframe.frameBorder = '0';
    iframe.setAttribute('allowfullscreen','');
    iframe.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
    iframe.loading = 'eager';
    embedDiv.appendChild(iframe);
    return embedDiv;
  }

  function loadMoreEpisodes() {
    const nextIndex = currentIndex + episodesPerPage;
    const slice = allEpisodes.slice(currentIndex, nextIndex);
    slice.forEach(item => {
      const episodeEl = createEpisodeElement(item);
      episodesContainer.appendChild(episodeEl);
    });
    currentIndex = nextIndex;
    if(currentIndex >= allEpisodes.length) loadMoreBtn.style.display = 'none';
    else loadMoreBtn.style.display = 'block';
  }

  loadMoreBtn.addEventListener('click', loadMoreEpisodes);

  async function loadEpisodes() {
    await loadSpotifyEpisodesMap();
    try {
      const response = await fetch(RSS_URL);
      const text = await response.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text,'application/xml');
      allEpisodes = Array.from(xml.querySelectorAll('item'));
      currentIndex = 0;
      episodesContainer.innerHTML = '';
      loadMoreEpisodes();

      // If there's a hash, auto-load until found
      await scrollToHashIfExists();
    } catch(e) {
      episodesContainer.innerHTML = '<p style="color:red;">Failed to load episodes.</p>';
      console.error(e);
    }
  }

  async function scrollToHashIfExists() {
    if(!window.location.hash) return;
    const hashRaw = window.location.hash.substring(1); // remove #
    const targetId = hashRaw.toLowerCase().replace(/\s+/g,'-').replace(/[^\w-]/g,'');

    while(!document.getElementById(targetId) && currentIndex < allEpisodes.length) {
      loadMoreEpisodes();
      await new Promise(r=>setTimeout(r,50));
    }

    const target = document.getElementById(targetId);
    if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
  }

  loadEpisodes();
</script>

</body>
</html>
